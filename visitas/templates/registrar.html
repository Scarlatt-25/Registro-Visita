{% extends 'base.html' %}
{% block content %}

<h2 style="text-align:center;">Registrar AtenciÃ³n - SalÃ³n de Belleza ðŸ’…</h2>

<style>
    .form-container {
        max-width: 700px;
        margin: auto;
        padding: 20px;
        font-family: Arial, sans-serif;
    }
    label { font-weight: bold; color: #5c2a57; }
    input, select, textarea { 
        width: 100%; padding: 10px; margin-top: 5px; 
        margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc;
    }
    button {
        padding: 12px; background-color: #ff6f91; color: white; border: none; 
        border-radius: 6px; font-size: 1em; cursor: pointer;
    }
    button:hover { background-color: #ff3f6c; }

    /* --- CHAT --- */
    #chatBubble {
        position: fixed; bottom: 30px; right: 30px; background-color: #ff6f91; 
        color: white; width: 60px; height: 60px; border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 30px; cursor: pointer; z-index: 999; 
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    #chatContainer {
        display: none; position: fixed; bottom: 100px; right: 30px; 
        width: 320px; height: 400px; background: white; 
        border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); 
        z-index: 1000; font-family: Arial, sans-serif;
        flex-direction: column;
    }
    #chatHeader {
        background-color: #ff6f91; color: white; padding: 10px;
        border-radius: 12px 12px 0 0; cursor: pointer;
        display: flex; justify-content: space-between;
    }
    #chatBody {
        flex-grow: 1; overflow-y: auto; padding: 10px;
        background-color: #f7f7f7;
    }
    .message {
        max-width: 80%; padding: 8px 12px; border-radius: 18px; 
        margin-bottom: 10px; font-size: 0.9em;
    }
    .ia-message {
        background-color: #e2e2e2;
    }
    .user-message {
        background-color: #ff6f91; color: white; margin-left: auto;
    }
    #chatInputArea {
        padding: 10px; border-top: 1px solid #ddd; display: flex;
    }
    #chatInputArea input {
        flex-grow: 1; border-radius: 20px; padding: 8px;
    }
    #chatInputArea button {
        margin-left: 5px;
    }
</style>

<div class="form-container">

    {% if form.errors %}
    <div style="color:red;">
        {{ form.errors }}
    </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <label>Cliente</label>
        {{ form.cliente }}

        <label>RUT</label>
        {{ form.rut }}

        <label>Fecha de visita</label>
        {{ form.fecha_visita }}

        <label>Servicio</label>
        {{ form.servicio }}

        <label>Precio ($)</label>
        {{ form.precio }}

        <button type="submit">Guardar AtenciÃ³n</button>
    </form>
</div>

<!-- CHAT -->
<div id="chatBubble" onclick="abrirChat()">ðŸ’¬</div>

<div id="chatContainer">
    <div id="chatHeader" onclick="cerrarChat()">
        <strong>Asistente IA ðŸ’–</strong>
        <span>&times;</span>
    </div>
    <div id="chatBody">
        <div class="message ia-message">
            Hola ðŸ’… Â¿en quÃ© te ayudo hoy?
        </div>
    </div>
    <div id="chatInputArea">
        <input type="text" id="preguntaIA" placeholder="Pregunta algo...">
        <button type="button" onclick="consultarIA()">Enviar</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

    // Fecha automÃ¡tica
    const fecha = document.getElementById("id_fecha_visita");
    if (fecha) {
        fecha.value = new Date().toISOString().split("T")[0];
    }

    // Precio automÃ¡tico
    const precios = {
        corte: 15000,
        tintura: 45000,
        manicure: 8000,
        pedicure: 12000,
        alisado: 60000,
        peinado: 20000,
        "perfilado de cejas": 5000,
        "lifting de pestaÃ±as": 18000
    };

    const servicio = document.getElementById("id_servicio");
    const precio = document.getElementById("id_precio");

    servicio.addEventListener("change", function () {
        precio.value = precios[this.value] || "";
    });
});

// CHAT
function abrirChat() {
    document.getElementById("chatContainer").style.display = "flex";
}
function cerrarChat() {
    document.getElementById("chatContainer").style.display = "none";
}
function consultarIA() {
    const input = document.getElementById("preguntaIA");
    const pregunta = input.value.trim();
    if (!pregunta) return;

    const chatBody = document.getElementById("chatBody");
    chatBody.innerHTML += `<div class="message user-message">${pregunta}</div>`;
    input.value = "";

    fetch("/api/sugerir-servicio/", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: "pregunta=" + encodeURIComponent(pregunta)
    })
    .then(res => res.json())
    .then(data => {
        chatBody.innerHTML += `<div class="message ia-message">${data.respuesta}</div>`;
        chatBody.scrollTop = chatBody.scrollHeight;
    });
}
</script>

{% endblock %}
